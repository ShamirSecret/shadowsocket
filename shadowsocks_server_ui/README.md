# Shadowsocks V2 Refactored

基于 shadowsocks 官方库的事件循环架构重构版本，修复连续下载断开问题。

## 架构说明

### 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                        GUI Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ Config Panel │  │ Monitor Panel│  │  Log Panel   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Server Layer                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         ShadowsocksServer                            │  │
│  │  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │  EventLoop    │  │  TCPRelayExt │               │  │
│  │  │ (shadowsocks) │  │  (extended)  │               │  │
│  │  └──────────────┘  └──────────────┘               │  │
│  │         │                  │                        │  │
│  │         └──────────┬───────┘                        │  │
│  │                    ▼                                 │  │
│  │         ┌──────────────────┐                        │  │
│  │         │  DNSResolver     │                        │  │
│  │         │  (shadowsocks)   │                        │  │
│  │         └──────────────────┘                        │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Shadowsocks Library (官方库)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  eventloop   │  │   tcprelay   │  │   encrypt    │   │
│  │  common      │  │  asyncdns    │  │              │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 模块说明

### 核心模块

- **server.py**: 服务器封装类，集成 EventLoop 和 TCPRelayExt
- **tcprelay_ext.py**: 扩展的 TCP 中继，继承 shadowsocks.tcprelay，添加统计和连接数限制

### GUI 模块

- **gui/main_window.py**: 主窗口，整合所有 GUI 组件
- **gui/config_panel.py**: 配置输入面板
- **gui/monitor_panel.py**: 实时监控面板
- **gui/log_panel.py**: 日志显示面板

### 配置和统计模块

- **config/manager.py**: 配置管理器
- **config/defaults.py**: 默认配置
- **stats/collector.py**: 统计信息收集器

## 与官方库的差异

### 架构差异

1. **事件循环架构** vs **线程池架构**
   - 官方库：使用 epoll/kqueue/select 事件驱动
   - 原版本：使用 ThreadPoolExecutor 线程池
   - 重构版本：采用官方库的事件循环架构

2. **非阻塞 I/O** vs **阻塞 I/O**
   - 官方库：所有 socket 设置为非阻塞，通过事件通知读写
   - 原版本：使用阻塞式 recv()/send()
   - 重构版本：采用官方库的非阻塞 I/O

3. **超时管理**
   - 官方库：时间戳队列 + 定期清理（`handle_periodic`）
   - 原版本：独立清理线程定期检查空闲连接
   - 重构版本：采用官方库的超时管理机制

### 功能扩展

1. **统计信息**: 添加连接数、流量统计
2. **连接数限制**: 添加最大连接数限制
3. **GUI 界面**: 提供图形化配置和监控界面

## 使用方法

### 运行 GUI 版本

```bash
python -m shadowsocks_server_ui.main
```

### 配置说明

配置文件：`shadowsocks_config.json`

```json
{
  "server": "0.0.0.0",
  "server_port": 1080,
  "password": "your_password",
  "method": "aes-256-cfb",
  "max_connections": 2000,
  "timeout": 43200,
  "target_connect_timeout": 30
}
```

## 修复的问题

### 连续下载断开问题

**原因分析**：
- 原版本使用线程池 + 阻塞 I/O，长时间下载时可能出现超时误判
- 原版本的超时管理机制不够精确

**解决方案**：
- 采用官方库的事件循环架构，精确管理连接超时
- 使用非阻塞 I/O，避免长时间阻塞
- 在数据传输时及时更新活动时间，确保长时间下载的连接不会被误判为空闲

## 技术要点

1. **事件循环集成**: 直接使用 shadowsocks 的 EventLoop
2. **超时管理修复**: 使用时间戳队列机制，精确管理连接超时
3. **数据转发优化**: 使用非阻塞 socket + 事件驱动
4. **统计信息集成**: 在 TCPRelayExt 中添加统计回调

## 依赖

- shadowsocks >= 2.8.2
- tkinter (Python 标准库)

## Python 3.13 兼容性

本项目包含 Python 3.13 兼容性修复，解决了 shadowsocks 2.8.2 中 `collections.MutableMapping` 的问题。

兼容性修复在 `compat.py` 中实现，会在导入 shadowsocks 库之前自动应用。

## 许可证

Apache License 2.0

